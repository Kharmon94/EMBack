#!/bin/bash -e

# Enable jemalloc for reduced memory usage and latency.
if [ -z "${LD_PRELOAD+x}" ]; then
    LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
    export LD_PRELOAD
fi

# If running the rails server then create or migrate existing database
# Check for both "./bin/rails server" and "bundle exec rails server"
if [[ "$*" == *"rails server"* ]] || [[ "$*" == *"rails s"* ]]; then
  echo "Running database migrations..."
  bundle exec rails db:prepare
  
  # Seed database if it's empty (check if users table is empty)
  echo "Checking if database needs seeding..."
  USER_COUNT=$(bundle exec rails runner 'puts User.count' 2>/dev/null || echo "0")
  
  if [ "$USER_COUNT" == "0" ]; then
    echo "Database is empty, running seed..."
    bundle exec rails db:seed
    echo "Seed completed!"
  else
    echo "Database already has $USER_COUNT users, skipping seed."
  fi
fi

exec "${@}"
